rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isActive() {
      return getUserData().isActive == true;
    }
    
    function isAdmin() {
      return getUserData().role == 'admin';
    }
    
    function isManager() {
      return getUserData().role == 'manager';
    }
    
    function isStaff() {
      return getUserData().role == 'staff';
    }
    
    function belongsToSameHotel(hotelId) {
      return getUserData().hotelId == hotelId;
    }
    
    function hasPermission(permission) {
      return getUserData().permissions.hasAny([permission, 'all']);
    }

    // Users collection - users can read/update their own profile
    match /users/{userId} {
      allow read: if isAuthenticated() && isActive() && 
        (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && isActive() && 
        (request.auth.uid == userId || isAdmin());
    }

    // Hotels collection
    match /hotels/{hotelId} {
      allow read: if isAuthenticated() && isActive() && 
        (isAdmin() || belongsToSameHotel(hotelId));
      allow write: if isAuthenticated() && isActive() && 
        (isAdmin() || (isManager() && belongsToSameHotel(hotelId)));
    }

    // Rooms collection
    match /rooms/{roomId} {
      allow read: if isAuthenticated() && isActive() && 
        (isAdmin() || belongsToSameHotel(resource.data.hotelId));
      allow write: if isAuthenticated() && isActive() && 
        (isAdmin() || 
         (belongsToSameHotel(resource.data.hotelId) && 
          (isManager() || hasPermission('manage_rooms'))));
    }

    // Guests collection
    match /guests/{guestId} {
      allow read: if isAuthenticated() && isActive() && 
        (isAdmin() || belongsToSameHotel(resource.data.hotelId));
      allow write: if isAuthenticated() && isActive() && 
        (isAdmin() || 
         (belongsToSameHotel(resource.data.hotelId) && 
          (isManager() || hasPermission('manage_guests'))));
    }

    // Reservations collection
    match /reservations/{reservationId} {
      allow read: if isAuthenticated() && isActive() && 
        (isAdmin() || belongsToSameHotel(resource.data.hotelId));
      allow write: if isAuthenticated() && isActive() && 
        (isAdmin() || 
         (belongsToSameHotel(resource.data.hotelId) && 
          (isManager() || hasPermission('manage_reservations'))));
    }

    // Invoices collection
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && isActive() && 
        (isAdmin() || belongsToSameHotel(resource.data.hotelId));
      allow write: if isAuthenticated() && isActive() && 
        (isAdmin() || 
         (belongsToSameHotel(resource.data.hotelId) && 
          (isManager() || hasPermission('manage_invoices'))));
    }

    // Analytics collection - read only for managers and admins
    match /analytics/{document=**} {
      allow read: if isAuthenticated() && isActive() && 
        (isAdmin() || isManager());
      allow write: if isAuthenticated() && isActive() && isAdmin();
    }

    // Audit logs - admin only
    match /audit_logs/{document=**} {
      allow read, write: if isAuthenticated() && isActive() && isAdmin();
    }
  }
}